# il vous faut la base GeoLite2-City.mmdb qui se télécharge grâce à un compte gratuit.
from scapy.all import *
from scapy.layers.inet import *
import socket
import datetime
import maxminddb as mdb
import ipaddress as ip


def process(pkt):
    _time = datetime.datetime.now()
    if IP in pkt:

        if socket.gethostbyname(socket.gethostname()) == pkt[IP].dst \
          or ip.IPv4Address(pkt[IP].dst).is_private is True:
            return

        city = db_city.get(pkt[IP].dst)
        try:
            nm_dst = socket.gethostbyaddr(pkt[IP].dst)[0]
        except socket.herror:
            nm_dst = 'unknown'

        if city is not None:
            if 'city' in list(city.keys()):
                city = f"city     = {city['city']['names']['en']}"
            else:
                city = f"location = {city['location']['time_zone']}"
    else:
        city = None

    if city is None:
        city = ''

    if pkt.haslayer(TCP):
        print(
            f'{_time} \tTCP  {pkt[IP].src:15} -> {pkt[IP].dst:15} {nm_dst:60} len = {len(pkt[TCP]):7} dport : {pkt.dport:5} {city}')

    if pkt.haslayer(UDP) and IP in pkt:
        print(
            f'{_time} \tUDP  {pkt[IP].src:15} -> {pkt[IP].dst:15} {nm_dst:60} len = {len(pkt[UDP]):7} dport : {pkt.dport:5} {city}')

    if pkt.haslayer(ICMP):
        print(f'{_time} \tICMP {pkt[IP].src:15} -> {pkt[IP].dst:15} {nm_dst:60} len = {len(pkt[ICMP]):7} {city}')


if __name__ == '__main__':

    db_city = mdb.open_database('GeoLite2-City.mmdb')
    try:
        sniff(prn=process)
    except KeyboardInterrupt:
        pass
    db_city.close()
