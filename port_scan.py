"""
scan d'une liste de ports disponibles
"""
from socket import *
# analyse des codes de retour en erreur
import errno

HOST = "192.168.1.44"
TO_SCAN = [21, 22, 25, 80, 143, 443, 993, 26033]

if __name__ == "__main__":
    opened_ports, available_ports, closed_ports = [], [], []

    for port in TO_SCAN:
        s = socket(AF_INET, SOCK_STREAM)
        s.settimeout(3)
        # s.connect_ex retourne un code de retour d'erreur
        # plutôt qu'une exception dans le cas de s.connect()
        ret = s.connect_ex((HOST, port))
        if ret == 0:
            # fermeture propre de la socket
            # RD: fin de réception
            # WR: fin d'envoi
            s.shutdown(SHUT_RDWR)
            s.close()
            opened_ports.append(port)
        # 10061: WSAECONNREFUSED => aucun serveur n'écoute
        # dispo pour une prote dérobée
        elif ret == 10061:
            available_ports.append(port)
        elif (errno.errorcode[ret] == "ECONNREFUSED" 
              # EAGAIN est remplacé par EWOULDBLOCK
              or errno.errorcode[ret] == "EAGAIN"):
            closed_ports.append(port)
        else:
            print(f"issue with port {port}: {ret} / {errno.errorcode[ret]}")
    print(f"opened: {opened_ports}")
    print(f"available for root-kit: {available_ports}")
    print(f"closed: {closed_ports}")

