from socket import *
import threading

## interfaces de la machine
# URL = "192.168.1.21"
# URL = "127.0.0.1"

## toutes les interfaces
# URL = "0.0.0.0"
URL = ""
PORT = 26029

def server_start():
    """
    démarrage du serveur
    """
    s = socket(AF_INET, SOCK_STREAM)
    # en mode server, on ne connecte pas,
    # on bind la socket sur une interface et un port
    s.bind((URL, PORT))
    # mise en place de l'écoute sur le port et 
    # gestion d'une file d'attente de 5 requêtes max
    s.listen(5)
    print("server started !")
    return s


# dans une fonction, utiliser les annotations
# pour renseigner le type d'un paramètre
# permet d'accéder à l'autocomplétion de vscode
def server_accept(s: socket):
    # accept() bloque le programme tant qu'on a pas reçu une
    # connexion client
    client_conn, addr = s.accept()
    print(f"accept cnx from {addr}")
    client_conn.settimeout(2)
    with client_conn:
        txt = ""
        while True:
            try:
                raw_data = client_conn.recv(1024)
                if raw_data == b'quit':
                    break
                if raw_data != b'':
                    txt += raw_data.decode("utf-8")
            except TimeoutError as e:
                # sendall: applique send() tant qu'il reste
                # des données à envoyer
                # transformation: on renvoie la chaine à l'envers
                client_conn.sendall(bytes(txt[::-1], "utf-8"))

# programme principal, directement lancé par
# l'interpréteur python
if __name__ == "__main__":
    server = server_start()
    # lancement de la fonction de gestion des cnx entrantes
    # dans un thread, donc non bloquant pour le thread principal
    thr = threading.Thread(target=server_accept, args=(server,))
    thr.start()

    # test du serveur avec une socket client
    with socket(AF_INET, SOCK_STREAM) as client:
        client.connect(("127.0.0.1", PORT))
        client.sendall(b"this is my data.")
        raw_data = client.recv(1024)
        print(f"response: {raw_data.decode('utf-8')}")
        client.sendall(b"quit")
    server.close()