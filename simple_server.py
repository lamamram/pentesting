from socket import *

## interfaces de la machine
# URL = "192.168.1.21"
# URL = "127.0.0.1"

## toutes les interfaces
# URL = "0.0.0.0"
URL = ""
PORT = 26029

def server_start():
    """
    démarrage du serveur
    """
    s = socket(AF_INET, SOCK_STREAM)
    # en mode server, on ne connecte pas,
    # on bind la socket sur une interface et un port
    s.bind((URL, PORT))
    # mise en place de l'écoute sur le port et 
    # gestion d'une file d'attente de 5 requêtes max
    s.listen(5)
    print("server started !")
    return s


# dans une fonction, utiliser les annotations
# pour renseigner le type d'un paramètre
# permet d'accéder à l'autocomplétion de vscode
def server_accept(s: socket):
    # accept() bloque le programme tant qu'on a pas reçu une
    # connexion client
    client_conn, addr = s.accept()
    print(f"accept cnx from {addr}")
    with client_conn:
       txt = ""
       while True:
         raw_data = client_conn.recv(1024)
         if raw_data != b'':
            txt += raw_data.decode("utf-8")
         else:
            # sendall: applique send() tant qu'il reste
            # des données à envoyer
            # transformation: on renvoie la chaine à l'envers
            client_conn.sendall(bytes(txt[::-1]), "utf-8")


# programme principal, directement lancé par
# l'interpréteur python
if __name__ == "__main__":
    server = server_start()
    server_accept(server)

    # test du serveur avec une socket client
    with socket(AF_INET, SOCK_STREAM) as client:
        client.connect(("127.0.0.1", PORT))
        client.sendall(b"this is my data.")
        raw_data = client.recv(1024)
        print(f"response: {raw_data.decode('utf-8')}")
    server.close()