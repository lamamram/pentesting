from socket import *
from OpenSSL import SSL
from timeout_decorator import timeout

# retrouver le fichier robots.txt sur un site en HTTPS
# fermeture de la connection au bout de 5 secondes
# par levée d'une exception SSL.ZeroReturnError
@timeout(5, timeout_exception=SSL.ZeroReturnError)
def get_robots(ssl, URL):
    ssl.connect((URL, 443))
    get = f'GET /robots.txt HTTP/1.1\r\nHost: {URL}\r\n\r\n'
    # envoi de la requête en TCP sous forme d'octets
    # retourne None en cas de succès ou lève une exception
    # garantie que tous les octets vont être envoyés
    ssl.sendall(bytes(get, 'utf-8'))
    
    while True:
        data = ssl.recv(1024)
        print(data.decode('utf-8'))


if __name__ == '__main__':
    URL = 'www.openssl.org'
    sock = socket(AF_INET, SOCK_STREAM)
    # utilisation du protocole TLS v1.2
    ctx = SSL.Context(SSL.TLSv1_2_METHOD)
    # encapsulation de la socket par la classe SSL
    ssl = SSL.Connection(ctx, sock)
    try:
        get_robots(ssl, URL)
    except SSL.ZeroReturnError:
        ssl.close()
        sock.close()