import rsa
import base64
from sys import argv


class RSA:

    # ------------------------------------------------------------
    def __init__(self, key_size, encoding='utf-8', hash='SHA-256'):

        self.public, self.private = rsa.newkeys(key_size)
        self.encoding = encoding
        self.hash = hash

    # ------------------------------------------------------------
    def pem_from_key(self, key):

        return key.save_pkcs1(format='PEM').decode(self.encoding)

    # ------------------------------------------------------------
    @staticmethod
    def key_from_pem(pem):

        if 'PUBLIC' in pem:
            key = rsa.PublicKey.load_pkcs1(pem, format='PEM')
        else:
            key = rsa.PrivateKey.load_pkcs1(pem, format='PEM')

        return key

    # ------------------------------------------------------------
    def encrypt(self, message, pubkey):

        return rsa.encrypt(bytes(message, self.encoding), pubkey)

    # ------------------------------------------------------------
    def decrypt(self, message, privkey):

        return rsa.decrypt(message, privkey).decode(self.encoding)

    # ------------------------------------------------------------
    def signature(self, message, privkey, b64=False):

        sign = rsa.sign(bytes(message, self.encoding), privkey, self.hash)

        if b64 is True:
            sign = base64.b64encode(sign).decode(self.encoding)

        return sign

    # ------------------------------------------------------------
    @staticmethod
    def save_to_file(buf, file, binary=True):

        mode = 'w'
        if binary is True:
            mode += 'b'

        with open(file, mode) as f:
            f.write(buf)

    # ------------------------------------------------------------
    @staticmethod
    def load_from_file(file):

        with open(file, 'rb') as f:
            buf = f.read()

        return buf

    # ------------------------------------------------------------
    def verify(self, message, hash, pubkey):

        try:
            good = rsa.verify(bytes(message, self.encoding), hash, pubkey) == self.hash
        except rsa.pkcs1.VerificationError:
            good = False

        return good


# ---------------------------------------------------------------------------------------------------------------------
if __name__ == '__main__':

    if len(argv) == 2 and argv[1] == '--gen_keys':

        mrsa = RSA(1024)
        RSA.save_to_file(mrsa.pem_from_key(mrsa.public), 'public.key', binary=False)
        RSA.save_to_file(mrsa.pem_from_key(mrsa.private), 'private.key', binary=False)
        print('Keys have been saved in files public.key and private.key')

    elif len(argv) == 4 and argv[1] == '--crypt_msg':
        msg = argv[2]

        with open(argv[3], 'r') as f:
            lines = f.readlines()
            key = ''
            for line in lines:
                key += line

        mrsa = RSA(256)
        enc = mrsa.encrypt(msg, RSA.key_from_pem(key))
        RSA.save_to_file(enc, 'msg.crypt')
        print('Crypted message has been saved in file msg.crypt')

    elif len(argv) == 4 and argv[1] == '--decrypt_msg':

        with open(argv[3], 'r') as f:
            lines = f.readlines()
            key = ''
            for line in lines:
                key += line

        with open(argv[2], 'rb') as f:
            msg = f.read()

        mrsa = RSA(256)
        dec = mrsa.decrypt(msg, RSA.key_from_pem(key))
        print(f'decyrpted message is : {dec}')

    elif len(argv) == 4 and argv[1] == '--sign':

        mrsa = RSA(256)
        with open(argv[3], 'r') as f:
            lines = f.readlines()
            key = ''
            for line in lines:
                key += line
        sign = mrsa.signature(argv[2], mrsa.key_from_pem(key))
        RSA.save_to_file(sign, 'msg.sign')
        print('Signature has been saved in file msg.sign')

    elif len(argv) == 5 and argv[1] == '--verify':

        mrsa = RSA(256)

        with open(argv[3], 'rb') as f:
            sign = f.read()

        with open(argv[4], 'r') as f:
            lines = f.readlines()
            key = ''
            for line in lines:
                key += line

        print(mrsa.verify(argv[2], sign, RSA.key_from_pem(key)))
